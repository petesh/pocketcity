
include Makefile-include

OBJECTS := stack.o simcity.o handler.o drawing.o globals.o build.o \
	simulation.o HiRes.o disaster.o palmutils.o \
	palm_locking.o beam.o \
	sony_support.o mem_compat.o pocketcity-sections.o \
	options.o map.o budget.o query.o savegame.o repeathandler.o \
	minimap.o \
	savegame_be.o pack.o \

BUILDENDS=nd d nd5 d5 nds ds dc
BUILDDIRS:=$(BUILDENDS:%=out-%)

DEBUG := 0
HIRES := 0
SONY := 0

# Multi language support - game-$(LANGUAGES).stm
LANGUAGES := EN

DESTOBJS = $(OBJECTS:%=$(OBJDIR)/%)
PRCTARGETS = $(LANGUAGES:%=$(OBJDIR)/$(BINARY)-%.prc)

LANGDIRS = $(LANGUAGES:%=(OBJDIR)/%)

.PHONY: all debug clean cheat hires dhires
.PRECIOUS: %.ro $(OBJDIR)/%-lang $(OBJDIR)/%-lang/game.ro \
		$(OBJDIR) .temp-%

TEMPENDS=$(LANGUAGES)
TEMPDIRS:=$(TEMPENDS:%=.temp-%)

#
# make all
#

lores dlores palm5 dpalm5 sony dsony: $(PRCTARGETS)

nearlylive: lores palm5 sony

debug: dlores dpalm5 dsony

#
# make cheat
#
cheat: CFLAGS += -DCHEAT
cheat: dlores

##################
### make debug ###
##################

# you can add: -DMEM_DEBUG to add logging of most palm memory allocation calls
# -mdebug-labels
dlores dpalm5 dsony: AXCFLAGS = -g -DDEBUG -DLOGGING
dlores dpalm5 dsony: DEBUG=1

palm5 dpalm5: BXCFLAGS = -DPALM_HIGH
palm5 dpalm5: HIRES=1

# Sony app also contains all the hires functionality
sony dsony: CXCFLAGS = -DSONY_CLIE -DPALM_HIGH
sony dsony: SONY=1

CFLAGS += $(AXCFLAGS) $(BXCFLAGS) $(CXCFLAGS) -DPROGTOKEN="'$(PROGTOKEN)'"

# the different language versions
$(OBJDIR)/$(BINARY)-%.prc: $(OBJDIR) $(OBJDIR)/PocketCity-EN \
		$(OBJDIR)/%-game.ro
	$(BUILDPRC) -o $@ -n $(PROGNAME) -c $(PROGTOKEN) pcity.def \
		$(OBJDIR)/PocketCity-EN $(OBJDIR)/$*-game.ro version.ro touch.ro

$(OBJDIR)/pocketcity-sections.o: $(OBJDIR)/pocketcity-sections.s
	$(CC) -c $< -o $@

$(OBJDIR)/pocketcity-sections.s $(OBJDIR)/pocketcity-sections.ld: pcity.def
	$(MULTIGEN) -b $(OBJDIR)/pocketcity-sections pcity.def

# Language
$(OBJDIR)/%-game.ro: $(OBJDIR) game.rcp langs.rcp \
		game.rcp langs.rcp simcity_resconsts.h graphic/pcity.bmp \
		graphic/pcity-hd.bmp graphic/pcity-color.bmp \
		graphic/pcity-color-hd.bmp \
		graphic/pcitysmall.bmp graphic/pcitysmall-hd.bmp \
		graphic/pcitysmall-color.bmp graphic/pcitysmall-color-hd.bmp
	$(AWK) -v DEBUG=$(DEBUG) -v HIRES=$(HIRES) \
		-v SONY=$(SONY) -f filter.awk \
		game.rcp > $(OBJDIR)/$*-ngame.rcp
	$(RC.rcp) -L $* $(OBJDIR)/$*-ngame.rcp $(OBJDIR)/$*-game.ro

$(OBJDIR)/%-lang:
	mkdir -p $@

#
# actual source
#

$(OBJDIR):
	@-[ -d "$@" ] || mkdir -p $@

$(OBJDIR)/PocketCity-EN: $(OBJDIR) $(DESTOBJS)
	$(CC) $(CFLAGS) $(LDFLAGS) $(DESTOBJS) -o $@ $(LDLIBS) \
		$(OBJDIR)/pocketcity-sections.ld

$(OBJDIR)/simcity.o: simcity.c simcity.h ../source/handler.h ../source/ui.h \
	../source/zakdef.h simcity_resconsts.h

$(OBJDIR)/%.o: ../source/%.c ../source/%.h ../source/zakdef.h ../source/ui.h \
                Makefile-include
	$(CC) $(CFLAGS) -c $< -o $@

$(OBJDIR)/%.o: frompalm/%.cpp
	$(CC) $(CFLAGS) -c $< -o $@

$(OBJDIR)/%.o: %.c simcity_resconsts.h Makefile-include pcity.def
	$(CC) $(CFLAGS) -c $< -o $@

#
# make clean 
#
clean:
	rm -f *.stm .temp*/*.bin build*/* *.zip *.gz
	rm -rf $(TEMPDIRS) .temp
	rm -rf $(BUILDDIRS)
