
include Makefile-include

OBJECTS := stack.o simcity.o handler.o drawing.o globals.o build.o \
	simulation.o HiRes.o disaster.o palmutils.o savegame_be.o \
	palm_locking.o \
	sony_support.o mem_compat.o pcity-sections.o \
	options.o map.o budget.o query.o savegame.o repeathandler.o \
	minimap.o

BUILDENDS=nd d nd5 d5 nds ds dc
BUILDDIRS:=$(BUILDENDS:%=.out-%)

DEBUG := 0
HIRES := 0
SONY := 0

# Multi language support - game-$(LANGUAGES).stm
LANGUAGES := EN

DESTOBJS = $(OBJECTS:%=$(OBJDIR)/%)
PRCTARGETS = $(LANGUAGES:%=$(BINARY)-%.prc)

LANGDIRS = $(LANGUAGES:%=(OBJDIR)/%)

.PHONY: all debug clean cheat hires dhires
.PRECIOUS: %.stm $(OBJDIR)/%-lang $(OBJDIR)/%-lang/game.stm \
		$(OBJDIR) .temp .temp-%

TEMPENDS=$(LANGUAGES)
TEMPDIRS:=$(TEMPENDS:%=.temp-%)

#
# make all
#

lores dlores palm5 dpalm5 sony dsony: $(PRCTARGETS)

nearlylive: lores palm5 sony

debug: dlores dpalm5 dsony

#
# make cheat
#
cheat: CFLAGS += -DCHEAT
cheat: dlores

##################
### make debug ###
##################

# you can add: -DMEM_DEBUG to add logging of most palm memory allocation calls
dlores dpalm5 dsony: AXCFLAGS = -g -DDEBUG
dlores dpalm5 dsony: DEBUG=1

palm5 dpalm5: BXCFLAGS = -DPALM_HIGH
palm5 dpalm5: HIRES=1

# Sony app also contains all the hires functionality
sony dsony: CXCFLAGS = -DSONY_CLIE -DPALM_HIGH
sony dsony: SONY=1

CFLAGS += $(AXCFLAGS) $(BXCFLAGS) $(CXCFLAGS)

# the different language versions
$(BINARY)-%.prc: $(OBJDIR) $(OBJDIR)/pcity $(OBJDIR)/%-lang/game.stm
	$(BUILDPRC) -o $@ -n $(PROGNAME) -c $(PROGTOKEN) pcity.def \
		$(OBJDIR)/pcity $(OBJDIR)/$*-lang/*.bin .temp/*.bin

$(OBJDIR)/pcity-sections.o: $(OBJDIR)/pcity-sections.s
	$(CC) -c $< -o $@

$(OBJDIR)/pcity-sections.s $(OBJDIR)/pcity-sections.ld: pcity.def
	$(MULTIGEN) -b $(OBJDIR)/pcity-sections pcity.def

# Language
$(OBJDIR)/%-lang/game.stm: $(OBJDIR) $(OBJDIR)/%-lang \
		game.rcp langs.rcp simcity_resconsts.h graphic/pcity.bmp \
		graphic/pcity-hd.bmp graphic/pcity-color.bmp graphic/pcity-color-hd.bmp \
		graphic/pcitysmall.bmp graphic/pcitysmall-hd.bmp \
		graphic/pcitysmall-color.bmp graphic/pcitysmall-color-hd.bmp
	@$(AWK) -v DEBUG=$(DEBUG) -v HIRES=$(HIRES) \
		-v SONY=$(SONY) -f filter.awk \
		game.rcp > $(OBJDIR)/$*-lang/ngame.rcp
	$(RC.rcp) -L $* $(OBJDIR)/$*-lang/ngame.rcp $(OBJDIR)/$*-lang
	@cat $(OBJDIR)/$*-lang/ngame.rcp > $@ && \
		rm -f $(OBJDIR)/$*-lang/ngame.rcp

$(OBJDIR)/%-lang:
	mkdir -p $@

#
# actual source
#

$(OBJDIR):
	@-[ -d "$@" ] || mkdir -p $@

$(OBJDIR)/pcity: $(OBJDIR) $(DESTOBJS)
	$(CC) $(CFLAGS) $(LDFLAGS) $(DESTOBJS) -o $@ $(LDLIBS) \
		$(OBJDIR)/pcity-sections.ld

$(OBJDIR)/simcity.o: simcity.c simcity.h ../source/handler.h ../source/ui.h \
	../source/zakdef.h simcity_resconsts.h

$(OBJDIR)/%.o: ../source/%.c ../source/%.h ../source/zakdef.h ../source/ui.h \
                Makefile-include
	$(CC) $(CFLAGS) -c $< -o $@

$(OBJDIR)/%.o: frompalm/%.cpp
	$(CC) $(CFLAGS) -c $< -o $@

$(OBJDIR)/%.o: %.c simcity_resconsts.h Makefile-include
	$(CC) $(CFLAGS) -c $< -o $@

#
# make clean 
#
clean:
	rm -f *.stm .temp*/*.bin build*/* *.zip *.gz
	rm -rf $(TEMPDIRS) .temp
	rm -rf $(BUILDDIRS)
